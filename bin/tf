#!/usr/bin/env python3
import os
import shutil
import sys
from pathlib import Path
from typing import Optional, Dict, List

DEFAULT_UVX_SOURCE = "https://github.com/legout/pi-ticketflow"

def read_root_file(path: Path) -> str:
    try:
        return path.read_text(encoding="utf-8").strip()
    except Exception:
        return ""


def find_repo_root() -> Optional[Path]:
    env_root = os.environ.get("TF_REPO_ROOT", "").strip()
    if env_root:
        path = Path(env_root).expanduser()
        if path.exists():
            return path

    cwd = Path.cwd()
    for parent in [cwd, *cwd.parents]:
        cli_root_file = parent / ".tf/cli-root"
        root_text = read_root_file(cli_root_file)
        if root_text:
            path = Path(root_text).expanduser()
            if path.exists():
                return path

    home_root_file = Path.home() / ".tf/cli-root"
    root_text = read_root_file(home_root_file)
    if root_text:
        path = Path(root_text).expanduser()
        if path.exists():
            return path

    here = Path(__file__).resolve()
    candidate = here.parent.parent
    if (candidate / "tf_cli").is_dir() and (candidate / "pyproject.toml").is_file():
        return candidate

    return None


def find_uvx_source() -> Optional[str]:
    env_source = os.environ.get("TF_UVX_FROM", "").strip()
    if env_source:
        return env_source

    cwd = Path.cwd()
    for parent in [cwd, *cwd.parents]:
        source_file = parent / ".tf/cli-source"
        source = read_root_file(source_file)
        if source:
            return source

    home_source_file = Path.home() / ".tf/cli-source"
    source = read_root_file(home_source_file)
    if source:
        return source

    return None


def find_legacy_script() -> Optional[Path]:
    env_path = os.environ.get("TF_LEGACY_SCRIPT", "").strip()
    if env_path:
        path = Path(env_path).expanduser()
        if path.is_file():
            return path

    cwd = Path.cwd()
    for parent in [cwd, *cwd.parents]:
        candidate = parent / ".tf/scripts/tf_legacy.sh"
        if candidate.is_file():
            return candidate

    global_legacy = Path.home() / ".tf/scripts/tf_legacy.sh"
    if global_legacy.is_file():
        return global_legacy

    repo_root = find_repo_root()
    if repo_root:
        candidate = repo_root / "scripts/tf_legacy.sh"
        if candidate.is_file():
            return candidate

    return None


def exec_with_env(cmd: List[str], env: Optional[Dict[str, str]] = None) -> None:
    if env is None:
        env = os.environ.copy()
    os.execvpe(cmd[0], cmd, env)


def main() -> None:
    args = sys.argv[1:]
    uvx = shutil.which("uvx")

    repo_root = find_repo_root()
    if repo_root:
        if uvx:
            exec_with_env(["uvx", "--from", str(repo_root), "tf", *args])
        python = shutil.which("python3") or shutil.which("python")
        if python:
            env = os.environ.copy()
            existing = env.get("PYTHONPATH", "")
            env["PYTHONPATH"] = (
                f"{repo_root}{os.pathsep}{existing}" if existing else str(repo_root)
            )
            exec_with_env([python, "-m", "tf_cli.cli", *args], env)

    uvx_source = find_uvx_source()
    if uvx and uvx_source:
        exec_with_env(["uvx", "--from", uvx_source, "tf", *args])

    legacy = find_legacy_script()
    if legacy:
        exec_with_env(["bash", str(legacy), *args])

    if uvx:
        exec_with_env(["uvx", "--from", DEFAULT_UVX_SOURCE, "tf", *args])

    python = shutil.which("python3") or shutil.which("python")
    if python:
        exec_with_env([python, "-m", "tf_cli.cli", *args])

    print("ERROR: Unable to locate Ticketflow CLI runtime.", file=sys.stderr)
    print("Install uvx or Python, or reinstall with the legacy shell script.", file=sys.stderr)
    raise SystemExit(1)


if __name__ == "__main__":
    main()
